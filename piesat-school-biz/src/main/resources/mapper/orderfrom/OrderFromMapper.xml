<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.piesat.school.biz.ds.orderfrom.mapper.OrderFromMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.piesat.school.biz.ds.orderfrom.entity.OrderFrom">
        <result column="id" property="id" />
        <result column="data_type" property="dataType" />
        <result column="download_user_id" property="downloadUserId" />
        <result column="auditor_user_id" property="auditorUserId" />
        <result column="data_info_id" property="dataInfoId" />
        <result column="created_at" property="createdAt" />
        <result column="updated_at" property="updatedAt" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id,
        data_type, download_user_id, auditor_user_id, data_info_id, created_at, updated_at
    </sql>
    <select id="orderFromMenu" resultType="com.piesat.school.orderfrom.vto.OrderFromVTO">
        SELECT
            o.id,
            o.data_type,
            o.download_user_id,
            d.data_name,
            d.pic,
            d.`status`,
            d.start_at,
            d.end_at,
            d.data_amount
        FROM
            t_order_from o
            LEFT JOIN t_data_inf d ON o.data_info_id = d.id
        WHERE
            o.auditor_user_id = #{orderFromMenuPageParamData.auditorUserId}
        <if test="orderFromMenuPageParamData.dataType != null and orderFromMenuPageParamData.dataType != 0" >
            AND o.data_type = #{orderFromMenuPageParamData.dataType}
        </if>
            AND o.is_delete != 1
    </select>
    
    <select id="orderFromInfo" parameterType="long" resultType="com.piesat.school.orderfrom.vto.OrderFromInfoVTO">
        SELECT
        o.data_type,
        o.download_user_id,
        d.data_name,
        d.`status`,
        o.created_at,
        o.explain
        FROM
        t_order_from o
        LEFT JOIN t_data_inf d ON o.data_info_id = d.id
        WHERE
        o.id = #{orderFromId}
    </select>

    <select id="attentionList" resultType="com.piesat.school.orderfrom.vto.OrderFromAttentionVTO">
        SELECT
            a.id,
            d.data_name,
            d.created_at,
            d.status,
            d.address,
            u2.name,
            d.upload_user_id
        FROM
            t_user u
            LEFT JOIN t_attention a ON u.id = a.user_id
            LEFT JOIN t_data_inf d ON a.data_id = d.id
            LEFT JOIN t_user u2 ON d.user_id = u2.id
        WHERE
            u.id = #{orderFromAttentionParamData.id}
        AND
            d.through_review = 1
        AND
            a.status = 1
    </select>

    <select id="historyDownload" resultType="com.piesat.school.orderfrom.vto.OrderFromHistoryDownLoadVTO">
        SELECT
            di.data_name,
            di.down_count,
            di.`status`,
            di.data_amount,
            hd.created_at
        FROM
            t_history_download hd
            LEFT JOIN t_data_inf di ON hd.data_id = di.id
            WHERE hd.user_id = #{orderFromAttentionParamData.historyUserId}
    </select>

    <update id="orderfromDelete">
        UPDATE t_order_from
        SET is_delete = 1
        WHERE id IN
        <foreach collection="list" item="id" index="index" open="(" close=")" separator=",">
            #{id}
        </foreach>

    </update>




</mapper>
